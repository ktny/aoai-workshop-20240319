---
title: 負荷分散の構成方法
---
import Img from "../../components/Img.tsx";

## 概要
負荷分散機能は、KIの負荷を複数台のサーバーの処理能力を活用して分散処理することで、多人数で同時アクセスする場合でも快適に利用するための機能です。\
特にマトリックスや要因ツリーにおける処理で効果を発揮します。\
本機能を利用するには、KIをインストールしたサーバーとは別のサーバーを複数台用意し、それぞれにノードをセットアップしてKIと接続します。\
\
KIで負荷分散機能を利用する方法について、説明します。\
以下の手順で行います。\
\
[ホストサーバーにKI本体をセットアップ](#ホストサーバーにki本体をセットアップ)\
[ノードサーバーのセットアップ](#ノードサーバーのセットアップ)\
[KIにノードを登録](#kiにノードを登録)

## ホストサーバーにKI本体をセットアップ
まだKIをセットアップしていない場合は、インストールマニュアルなどを参照し、ホストサーバーにKIをインストールしてください。\
ホストサーバーでは、負荷分散機能のために以下のポートを利用します。

| ポート番号 | 用途 |
| ---------- | ---- |
| 24224/tcp | Fluentd ポート。ホストサーバーにノードサーバーのログを集約するために使います。 |
| 5432/tcp | PostgreSQLデータベース。ノードサーバーからホストサーバーにアクセスして同期するために使います。 |

ノードサーバーからホストサーバーのこれらのポートにアクセスできるようにサーバーやネットワークを設定してください。

:::note{.point}
ポイント

ホストサーバーにてファイアウォールを設定している場合、ファイアウォールに除外設定が必要です。\
Windowsファイアウォールを使用する場合の設定例を以下に示します。

1. コントロールパネル > システムとセキュリティ > Windows Defender ファイアウォール >  詳細設定
1. [受信の規則]を右クリックし、[新しい規則]を開き、下記設定で受信の規則を作成する
   - ポート：TCP
   - 特定のローカルポート：5432, 24224
   - 接続を許可する
1. [受信の規則]を右クリックし、[新しい規則]を開き、下記設定で受信の規則を作成する
   - ポート：TCP
   - すべてのローカルポート
   - 接続を許可する
1. 3.で作成した受信の規則をダブルクリックし、下記を設定する
   - スコープ
   - リモートIPアドレス > これらのIPアドレス：10.170.170.170
:::

## ノードサーバーのセットアップ
ノードサーバーにノードをインストールします。\
事前に以下のファイルを取得してノードサーバーへ配置してください。

- ノードのインストーラー：\
  KIのインストーラーに同梱されています。\
  KIのインストーラーはKIサクセスサイトなどから[ダウンロード](/installer/index.html)してください。
- ノード構成ファイル：\
  KIに管理者でログイン後、システム設定から[ノード構成]メニューに移動し、[ノード構成ファイルをダウンロード]からファイルをダウンロードしてください。

### Linux版
:::note{.point}
ポイント

以降のコマンドは、root、またはsudo可能なユーザーで実行してください。
:::
:::note{.hint}
ヒント

- tarコマンドが存在しない場合は、tarコマンドをインストールしてください。
- プロキシサーバーを使用している環境の場合は、環境変数http_proxyとhttps_proxyを設定してください。
:::

1. KIのインストーラーを展開します。\
   例)
   ```
   $ tar xf KI-ST00SV_ubuntu-2004_2_3_0.tar
   ```
1. 展開したディレクトリ配下のnode-setupを実行してインストールを開始します。\
   例)
   ```
   $ ./KI-ST00SV_ubuntu-2004_2_3_0/node-setup
   ```
1. インストールが開始されると、以下の例)のように設定項目が順番に表示されますので、各項目を設定してインストールを進めてください。\
   例)
   ```
   Checking the Installation of Packages...
   ./ubuntu-2004_docker-repo.tar.gz: OK
   ./setup: OK
   ./setenv: OK
   　：
   　：
   Data directory [/opt/ki/data]:
   Log directory [/opt/ki/logs]:
   Unique node name [ubuntu18043]:
   Node configuration file path [/root/nodekey.p12]:
   Primary KI host FQDN or IP address [192.168.0.75]:
   　：
   ```
   | 項目名 | 説明 |
   | ------ | ---- |
   | Data directory | KIで使用するデータを保存するディレクトリを設定します。 |
   |  | 省略した場合は、「/opt/ki/data」が設定されます。 |
   |  | ※ディレクトリを指定する際は、「/share」などの親ディレクトリを直接指定しないでください。 |
   |  | 「/share/ki/data」などKIのデータ領域専用のディレクトリとなるように指定してください。 |
   |  | ディレクトリは事前に作成する必要はございません。インストール時に自動で生成されます。 |
   | Log directory | ログを保存するディレクトリを設定します。 |
   |  | 省略した場合は、「/opt/ki/logs」が設定されます。 |
   |  | ※ディレクトリを指定する際は、「/share」などの親ディレクトリを直接指定しないでください。 |
   |  | 「/share/ki/logs」などKIのログ領域専用のディレクトリとなるように指定してください。 |
   |  | ディレクトリは事前に作成する必要はございません。インストール時に自動で生成されます。 |
   | Unique node name | ノード名を指定します。 |
   |  | 省略した場合は、[]内に表示されている名前が設定されます。 |
   |  | 例)ubuntu20043 |
   | Node configuration file path | ノード構成ファイルが配置されているファイルパスを入力します。 |
   | Primary KI host FQDN or IP address | KIホストサーバーのIPアドレスかFQDNを入力します。 |
1. 設定した内容と確認メッセージ「Continue? (yes/no):」が表示されますので、設定内容を確認して「yes」を入力します。\
   例)
   ```
   Data directory: /opt/ki/data
   Log directory: /opt/ki/logs
   Node name: node01
   Node key file path: /root/nodekey.p12
   Primary KI host: 192.168.0.75
   Continue? (yes/no): yes
   　　：
   　　：
   ```
   \
   画面上に「Installation succeeded.」が表示されると、インストールは完了となります。
   :::note{.hint}
   ヒント

   インストールログを確認する場合は、コンソール画面にファイルパスが表示されますので、そちらを参照してください。\
   例)
   ```
   　　：
   　　：
   Installation succeeded.
   Installation log was saved to: /root/KI-ST00SV_ubuntu-2004_2_3_0/logs/InstallLog_20230929T044010+0000.log
   　　：
   　　：
   ```
   :::

### Windows版
:::note{.point}
ポイント

ノードは、Hyper-V上に構築されます。\
Hyper-Vの使用にあたり、以下の点に注意してください。
- BIOSの設定で「Intel Virtualization Technology」(Intel VT-x)を有効にしてください。
- 競合する他の仮想化ソフトウェアを使用していると、正常に動作しない場合があります。
:::

1. ノードサーバーに管理者権限のあるユーザーでログオンします。
1. インストール媒体(「KI-ST00SV_windows_1_1_0.zip」など)をエクスプローラーなどで解凍します。
1. インストール媒体が展開されていることを確認して、解凍したフォルダー配下の「node-setup\ki-node-setup.exe」を実行します。
   :::note{.hint}
   ヒント

   - Hyper-Vがインストールされていない環境の場合は、Hyper-Vをインストールするダイアログが表示されますので、画面の指示に沿ってインストールしてください。
   - 「ki-node-setup.exe」を実行すると、同じフォルダー内に以下2つのログファイルが作成されます。\
     ファイル名の「YYYYMMDDHHMMSS」は、「ki-node-setup.exe」を実行した日付となります。
     - ki_setup_YYYYMMDDHHMMSS.log
     - ki_install_YYYYMMDDHHMMSS.log
   :::
1. 「KI セットアップ ウィザードへようこそ」と表示されますので、[次へ]ボタンをクリックします。
   :::note{.hint}
   ヒント

   - Hyper-Vが無効になっている場合は有効化されます。\
   有効化にあたり、サーバーの再起動、およびサーバー再起動後10分程度必要となりますので、そのまましばらくお待ちください。
   - Windowsが再起動した後、インストーラーが自動で起動しない場合は、再度「ki-node-setup.exe」を実行してください。
   :::
1. [インストール先フォルダー]画面が表示されますので、以下の項目を指定して[次へ]ボタンをクリックします。\
   :version[2.2.0]

   | 項目名 | 説明 |
   | ------ | ---- |
   | KIのインストール先 | インストール先フォルダーのパスを指定します。 |
   |  | デフォルトでは以下のフォルダーが設定されています。 |
   |  | C:\Program Files\KEYENCE\KI |
   | 仮想ハードディスクの配置場所 | 仮想ディスクを配置するフォルダーのパスを指定します。 |
   |  | デフォルトでは以下のいずれかのフォルダーが設定されています。 |
   |  | - C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks |
   |  | - C:\ProgramData\Microsoft\Windows\Virtual Hard Disks |

1. [パラメータ]画面が表示されますので、各種設定をおこない[次へ]ボタンをクリックします。\
   :version[2.2.0]
   | 項目名 | 説明 |
   | ------ | ---- |
   | メモリー容量 | 使用するメモリー容量を指定します。 |
   | ディスク容量 | 仮想ディスクに割り当てるディスク容量を指定します。 |
   |  | なお、インストール時に指定したディスク容量以上の空き容量が無い場合は、インストールに失敗します。 |
   | ノード名 | ノード名を指定します。 |
   |  | 複数のノードを使用する場合は、それぞれ異なるノード名にしてください。 |
   | KIホストのIPアドレスまたはFQDN | KIホストサーバーのIPアドレスかFQDNを指定します。 |
   | ノード構成ファイルのパス | ノード構成ファイルが配置されているファイルパスを指定します。 |
1. [KIのインストール準備完了]画面が表示されますので、[インストール]ボタンをクリックします。
1. [KI セットアップ]画面に「KI セットアップ ウィザードが完了しました」と表示されますので、[完了]ボタンをクリックします。
:::note{.hint}
ヒント

セットアップがうまくいかない場合、以下をご確認ください。
- ノードサーバーからホストサーバーに以下のポートでアクセスできること\
  24224/tcp, 5432/tcp
- KIから取得した証明書が正しいこと
:::

ノードサーバーでは、以下のポートを利用します。
| ポート番号 | 用途 |
| ------ | ---- |
| 5432/tcp | PostgreSQLデータベース。ホストサーバーからのSQL要求を受け付けるために使います。|

マスターサーバーからこのポートにアクセスできるようにサーバーやネットワークを設定してください。
:::note{.point}
ポイント

ノードサーバーにてファイアウォールを設定している場合、ファイアウォールに除外設定が必要です。\
Windowsファイアウォールを使用する場合の設定例を以下に示します。
1. コントロールパネル > システムとセキュリティ > Windows Defender ファイアウォール >  詳細設定
1. [受信の規則]を右クリックし、[新しい規則]を開き、下記設定で受信の規則を作成する
   - ポート：TCP
   - 特定のローカルポート：5432
   - 接続を許可する
1. [受信の規則]を右クリックし、[新しい規則]を開き、下記設定で受信の規則を作成する
   - ポート：TCP
   - すべてのローカルポート
   - 接続を許可する
1. 3.で作成した受信の規則をダブルクリックし、下記を設定する
   - スコープ
   - リモートIPアドレス > これらのIPアドレス：10.170.170.170
:::

## KIにノードを登録
KIのシステム設定でノードを追加して、ノード構成での運用を開始します。

1. KIに管理者でログイン後、システム設定から[ノード構成]メニューを選択します。
1. [ノード構成]画面にて、[+ノード新規追加]ボタンをクリックし、追加するノードのIPアドレスまたはホスト名を指定してください。

   <Img src="/assets/img/capture/capture-node-1.png" alt="[ノード構成]画面" client:load />

   ノードが追加されると、画面の一覧に表示されます。
1. [運用停止中]ボタンをクリックすると、再起動後に負荷分散構成での運用を開始します。\
   運用が開始されると、ボタンの表示が[運用中]に切り替わります。運用を停止する場合は、再度ボタンをクリックしてください。
   :::note{.hint}
   ヒント

   ノードを削除する場合は、運用停止中に[ノード構成]画面上で削除するノードにマウスオーバーし、[ごみ箱]ボタンをクリックしてください。
   :::

## 運用上の注意

### 負荷分散構成でのシャットダウン・開始方法
KIが稼働中は、ノードサーバーは常に稼働するようにしてください。\
したがって、KIが稼働するサーバーとノードサーバーとを停止する際には、以下手順で実施してください。
1. ホストサーバー(KIサーバー)を停止
1. ノードサーバーを停止

反対に開始する際には、以下手順で実施してください。

1. ノードサーバーを開始
1. ホストサーバー(KIサーバー)を開始

### 負荷分散構成でノードと接続できなくなった場合
負荷分散構成で運用中にノードと接続できなくなった場合は、KIは自動的に当該ノードを切り離して運用を継続します。\
切り離されたノードは、システム設定配下の[ノード構成]画面で確認可能です。\
障害発生中は、ノードの復旧に備えてKIにて同期用のデータを保持し続けます。\
ノードを復旧させない場合は、[ノード構成]画面で当該ノードを削除してください。

### ノードサーバーを再セットアップする場合
何らかの要因でノードサーバーのデータベースが破損した場合、ノードサーバーを再セットアップするか、データベースを再同期することで復旧可能です。\
データベースの再同期は、以下の手順に沿って実行してください。

#### Linux版
管理者権限で以下コマンドを実行してください。
```
# /usr/local/sbin/ki-resync
```

#### Windows版
「C:¥Program Files¥KI」内の「ki-resync.bat」を実行してください。

### KIをバージョンアップする場合
KIのバージョンと、ノードのバージョンとは合わせる必要があります。\
KIをバージョンアップする場合は、ノードもKIと同じバージョンにバージョンアップしてください。\
バージョンアップの手順については、「[ノードのバージョンアップ](#ノードのバージョンアップ)」を参照してください。

## ノードのバージョンアップ
旧バージョンがインストールされている環境に対して、ノードをバージョンアップする手順を説明します。\
事前にKIサクセスサイトなどからバージョンアップするインストーラーを[ダウンロード](/installer/index.html)し、ノードサーバーへ配置してください。

### Linux版
:::note{.point}
ポイント

以降のコマンドは、root、またはsudo可能なユーザーで実行してください。
:::
:::note{.hint}
ヒント

- tarコマンドが存在しない場合は、tarコマンドをインストールしてください。
- プロキシサーバーを使用している環境の場合は、環境変数http_proxyとhttps_proxyを設定してください。
:::

1. ノードが稼働しているサーバーにログインし、KIのインストーラーを展開します。\
   例)
   ```
   $ tar xf KI-ST00SV_ubuntu-2004_2_3_0.tar
   ```
1. 展開したディレクトリ配下のnode-updateを実行してアップデートを開始します。\
   例)
   ```
   $ ./KI-ST00SV_ubuntu-2004_2_3_0/node-update
   ```
1. アップデートを開始すると、確認メッセージ「Continue? (yes/no):」が表示されますので、「yes」を入力します。
   ```
   Update KI.
   Continue? (yes/no): yes
   　　：
   　　：
   ```
   画面上に「Update succeeded.」が表示されると、アップデートは完了となります。
   :::note{.hint}
   ヒント

   アップデートログを確認する場合は、コンソール画面にファイルパスが表示されますので、そちらを参照してください。\
   例)
   ```
   　　：
   　　：
   Update succeeded.
   Update log was saved to: /dev/shm/KI-ST00SV_ubuntu-2004_2_3_0/logs/UpdateLog_20230929T044853+0000.log
   　　：
   　　：
   ```
   :::

### Windows版
1. ノードサーバーに管理者権限のあるユーザーでログオンします。
1. インストール媒体(「KI-ST00SV_windows_2_1_2.zip」など)をエクスプローラーなどで解凍します。
1. インストール媒体が展開されていることを確認して、解凍したフォルダー配下の「node-setup\ki-node-setup.exe」を実行します。

   :::note{.hint}
   ヒント

   「ki-node-setup.exe」を実行すると、同じフォルダー内に以下2つのログファイルが作成されます。\
   ファイル名の「YYYYMMDDHHMMSS」は、「ki-node-setup.exe」を実行した日付となります。
   - ki_setup_YYYYMMDDHHMMSS.log
   - ki_install_YYYYMMDDHHMMSS.log
   :::

1. 「KI セットアップ ウィザードへようこそ」と表示されますので、[次へ]ボタンをクリックします。
1. [インストール先フォルダー]画面が表示されますので、インストール先を指定して[次へ]ボタンをクリックします。
1. [パラメータ]画面が表示されますので、[次へ]ボタンをクリックします。
1. [KIのインストール準備完了]画面が表示されますので、[インストール]ボタンをクリックします。
1. [KI セットアップ]画面に「KI セットアップ ウィザードが完了しました」と表示されますので、[完了]ボタンをクリックします。
:::note{.hint}
ヒント

セットアップがうまくいかない場合、以下をご確認ください。
- ノードサーバーからホストサーバーに以下のポートでアクセスできること\
  24224/tcp, 5432/tcp
- KIから取得した証明書が正しいこと
:::

## ノードのアンインストール
ノードをアンインストールする場合は、以下の手順に沿って実施してください。

### Linux版
:::note{.point}
ポイント

以降のコマンドは、root、またはsudo可能なユーザーで実行してください。
:::

1. ノードをセットアップしたサーバーにログインし、以下のコマンドを実行してください。
   ```
   $ /usr/local/share/ki/uninstall
   ```
1. 確認メッセージ「Continue? (yes/no):」がコンソール上に表示されますので、「yes」を入力します。
   ```
   Uninstall ki.
   Continue? (yes/no): yes
   ```
   画面上に「Uninstallation completed.」が表示されると、アンインストールは完了となります。

:::note{.hint}
ヒント

アンインストールを実施しても、以下フォルダ配下に格納されているユーザーデータ(データセットやプロジェクトなどの各種データ)は、削除されません。\
これらのデータは、次回再インストールする場合に使用されます。不要な場合は、手動で削除してください。
- インストール時に指定したData directory： データセットやプロジェクトなどの各種データ
- インストール時に指定したLog directory： ログデータ
- 「/usr/local/etc/ki」：設定ファイルなど
:::

### Windows版
1. 管理者権限のあるユーザーでノードをセットアップしたマシンにログオンします。
1. [スタート]ボタンをクリックし、[コントロール パネル]に移動します。
1. [コントロール パネル]画面から[プログラムのアンインストール]をクリックします。
1. [プログラムと機能]画面にて、[KI]を選択後に[アンインストール]ボタンをクリックします。
:::note{.hint}
ヒント

アンインストールを実施しても、仮想ディスクファイルは、削除されません。\
次回再インストールする場合に使用されます。不要な場合は手動で削除してください。
:::
